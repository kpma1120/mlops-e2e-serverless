name: CI/CD Deployment to GKE

on:
  push:
    branches:
      - main
    tags:
      - "init-data-*"

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: "my-cluster"
  GKE_REGION: "us-east1"
  REPOSITORY: "us-east1-docker.pkg.dev/mlops-repo1/my-repo"
  FASTAPI_IMAGE: "us-east1-docker.pkg.dev/mlops-repo1/my-repo/fastapi"
  FLASK_IMAGE: "us-east1-docker.pkg.dev/mlops-repo1/my-repo/flask"
  GRAFANA_IMAGE: "grafana/grafana:latest"
  PROMETHEUS_IMAGE: "prom/prometheus:latest"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    container:
      image: google/cloud-sdk:latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Authenticate with Google cloud
        uses: 'google-github-actions/auth@v3'
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
      
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker us-east1-docker.pkg.dev
      
      - name: Install Docker CLI
        run: |
          apt-get update
          apt-get install -y docker.io
      
      - name: Build and Push FastAPI Image
        run: |
          docker build -t $FASTAPI_IMAGE:$GITHUB_SHA -t $FASTAPI_IMAGE:latest -f fastapi/Dockerfile ./
          docker push $FASTAPI_IMAGE:$GITHUB_SHA
          docker push $FASTAPI_IMAGE:latest

      - name: Build and Push Flask Image
        run: |
          docker build -t $FLASK_IMAGE:$GITHUB_SHA -t $FLASK_IMAGE:latest ./flask
          docker push $FLASK_IMAGE:$GITHUB_SHA
          docker push $FLASK_IMAGE:latest

      - name: GKE Configuration
        run: |
          gcloud container clusters get-credentials $GKE_CLUSTER --region $GKE_REGION --project $PROJECT_ID

      - name: Sync ConfigMaps from repo files
        run: |
          kubectl create configmap prometheus-config --from-file=prometheus.yml --dry-run=client -o yaml | kubectl apply -f -
          kubectl create configmap grafana-provisioning-dashboards --from-file=provisioning/dashboards --dry-run=client -o yaml | kubectl apply -f -
          kubectl create configmap grafana-provisioning-datasources --from-file=provisioning/datasources --dry-run=client -o yaml | kubectl apply -f -

      - name: Reload Prometheus config via API (with fallback)
        run: |
          kubectl port-forward svc/prometheus-service 9090:9090 &
          sleep 5
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://127.0.0.1:9090/-/reload)
          if [ "$STATUS" -ne 200 ]; then
            echo "Prometheus reload failed (HTTP $STATUS), fallback to rollout restart"
            kubectl rollout restart deployment prometheus
          else
            echo "Prometheus reload succeeded"
          fi

      - name: Restart Grafana to pick up new ConfigMaps
        run: |
          kubectl rollout restart deployment grafana

      - name: Apply PVC
        run: |
          kubectl apply -f monitoring-pvc.yml

      - name: Deploy All Services
        run: |
          kubectl apply -f all-services.yml

      - name: Update FastAPI Image
        run: |
          kubectl set image deployment/fastapi fastapi=$FASTAPI_IMAGE:$GITHUB_SHA

      - name: Update Flask Image
        run: |
          kubectl set image deployment/flask flask=$FLASK_IMAGE:$GITHUB_SHA

      - name: Initialize Prometheus Data (only on init-data-* tag)
        if: startsWith(github.ref, 'refs/tags/init-data-')
        run: |
          tar czf prometheus-data.tar.gz prometheus-data/
          PROM_POD=$(kubectl get pod -l app=prometheus -o jsonpath="{.items[0].metadata.name}")
          kubectl cp prometheus-data.tar.gz $PROM_POD:/prometheus
          kubectl exec $PROM_POD -- tar xzf /prometheus/prometheus-data.tar.gz -C /prometheus
